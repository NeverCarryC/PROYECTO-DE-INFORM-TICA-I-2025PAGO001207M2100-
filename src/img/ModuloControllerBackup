package controller;


import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import db.AsignaturaCRUD;
import db.ModuloCRUD;
import db.UnidadCRUD;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.geometry.Insets;
import javafx.scene.Parent;
import javafx.scene.control.Accordion;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonBar.ButtonData;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.ListCell;
import javafx.scene.control.ListView;
import javafx.scene.control.MenuItem;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.control.TextInputDialog;
import javafx.scene.control.TitledPane;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.VBox;
import javafx.stage.FileChooser;
import javafx.util.Callback;
import javafx.util.Pair;
import model.AppSession;
import model.Asignatura;
import model.Modulo;
import model.Unidad;
import model.UnidadPrueba;

public class ModuloController {

	private int id_asignatura;
    @FXML
    private Accordion accordion;
    
    private ContextMenu currentContextMenu;// ä¸ç„¶å°±ä¼šå‡ºç°ï¼Œå³é”®ç‚¹å‡»å‡ºç°å¤šä¸ªContextMenu
 
    @FXML
 // CONOCIMIENTO: CICLO DE VIDA DE FXML VIEW
 // No se debe poner en initialize() ninguna operaciÃ³n que dependa
 // de parÃ¡metros externos (por ejemplo, id_asignatura).
 //
 // Esto se debe al orden del ciclo de vida de JavaFX.
 //
 // RazÃ³n principal: el orden temporal.
 //
 // El flujo es el siguiente:
 //
 // 1. Se ejecuta loader.load()
 //
 // 2. JavaFX crea una nueva instancia del controlador (new ModuloController())
 //
 // 3. JavaFX inyecta los elementos @FXML (por ejemplo, el accordion)
 //
 // 4. JavaFX ejecuta inmediatamente initialize()
 //
//     ğŸš¨ En este momento, todavÃ­a NO se ha llamado a setId_asignatura(),
//     por lo que this.id_asignatura sigue con el valor por defecto: 0.
 //
//     Si hiciÃ©ramos aquÃ­ la consulta a la base de datos, se buscarÃ­an
//     los datos con ID = 0 (lÃ³gicamente vacÃ­os).
 //
 // 5. loader.load() termina y devuelve la vista
 //
 // 6. Se obtiene el controlador con loader.getController()
 //
 // 7. Finalmente, se llama manualmente a controller.setId_asignatura(id)
 //
//     âœ… Solo en este momento el ID llega correctamente.
 //
    public void initialize() {
    }
    public void cargarUnidadesYAsignatura(int id_asignatura) {

    	// Obtener la lista de unidades y modulos desde la base de datos segÃºn el id_asignatura
    	ArrayList<Unidad> unidades = UnidadCRUD.getUnidadsByIdAsignatura(id_asignatura);
    	System.out.println(unidades);
    	// Comprobar si no hay unidades disponibles
        if (unidades == null || unidades.isEmpty()) {
            // Crear un VBox como contenedor de un mensaje de "sin contenido"
            VBox emptyBox = new VBox();
            emptyBox.setPadding(new Insets(20));
            // Crear una etiqueta con el mensaje
            Label emptyLabel = new Label("(No hay contenido disponible)");
            emptyLabel.setStyle("-fx-text-fill: gray; -fx-font-style: italic;");
            emptyBox.getChildren().add(emptyLabel);
            
            // Crear un TitledPane para mostrar el mensaje en el Accordion
            // Un accordion tiene muchos titledPan(1:N)
            TitledPane emptyPane = new TitledPane("Infoï¼š No hay contenido disponible", emptyBox);
            accordion.getPanes().add(emptyPane);
            return; // Terminar el mÃ©todo si no hay unidades
        }
        
        //  Iterar sobre cada unidad y crear su correspondiente secciÃ³n en el Accordion
    	for(Unidad u :unidades) {
    		 // Crear un VBox contenedor para cada Ã­tem del Accordion
	        VBox box = new VBox(10);
	        box.setPadding(new Insets(10));
	        
	        // Etiqueta para la descripciÃ³n de la unidad (con ajuste de texto automÃ¡tico)
	        Label descripcionLabel = new Label();
	        descripcionLabel.textProperty().bind(u.descripcionProperty());
	        descripcionLabel.setWrapText(true);
	        
	        // Etiqueta para el tÃ­tulo "Temario"
	        Label temarioLabel = new Label("Temario");
	        temarioLabel.setStyle("-fx-font-weight: bold; -fx-font-size: 14px;");
	        
	        // ListView para mostrar los mÃ³dulos de la unidad
	        // 1. Crear un ListView vacÃ­o de tipo Modulo
	        ListView<Modulo> moduloListView = new ListView<>();
	        // ListView es un control que muestra una lista vertical desplazable.
	        // El tipo <Modulo> indica que cada elemento de la lista es un objeto Modulo.
	        
	        // 2. Convertir la lista de mÃ³dulos de la unidad en un ObservableList
	        ObservableList<Modulo> observableList = FXCollections.observableArrayList(u.getModulos());
	        // u.getModulos() devuelve un List<Modulo> normal de Java.
	        // FXCollections.observableArrayList(...) lo convierte en ObservableList, que es "observable":
	        // cuando se agregan, eliminan o modifican elementos, la UI se actualiza automÃ¡ticamente.
	        
	        // 3. Establecer la lista observable como fuente de datos del ListView
	        moduloListView.setItems(observableList);
	 
	        setupModuloListView(moduloListView, u, observableList);
	        
	        // A partir de este momento, el ListView muestra todos los Modulos del ObservableList.
	        // Si se modifica observableList (aÃ±adir, eliminar, cambiar), ListView se actualiza automÃ¡ticamente.
	        // Nota: ListView no almacena los datos por sÃ­ mismo, solo los muestra.
	        
	        // Agregar la descripciÃ³n, el tÃ­tulo y la lista de mÃ³dulos al VBox
	        box.getChildren().addAll(descripcionLabel, temarioLabel, moduloListView);
	        
	        // Crear un TitledPane para la unidad y aÃ±adirlo al Accordion
	        TitledPane pane = new TitledPane();
	        pane.textProperty().bind(u.nombreProperty());
	        pane.setContent(box);
	        
	        
	        
	        
	        // ç”¨æˆ·å³é”®ç‚¹å‡»Unidad, ç¼–è¾‘ï¼Œåˆ é™¤
	        pane.addEventHandler(MouseEvent.MOUSE_CLICKED, event ->{
	        	if(event.getButton() == javafx.scene.input.MouseButton.SECONDARY) {
	        		if (currentContextMenu != null) {
	        			currentContextMenu.hide();
	        		}
	        		
	        		//System.out.println("å³é”®ç‚¹å‡»äº†å•å…ƒ: " + u.getNombre());
	        		// System.out.println("ID de Unidad: " + u.getId());
	        		ContextMenu contextMenu = createContextMenuForUnidad(u, pane);
	        		contextMenu.show(pane, event.getScreenX(), event.getScreenY());
	        		// æ›´æ–° currentContextMenu å­—æ®µä¸ºå½“å‰æ˜¾ç¤ºçš„èœå•
	        		currentContextMenu = contextMenu;
	        		
	        		// event.consume();
	        	}else {
					//System.out.println("ç‚¹åˆ°äº†åˆ«çš„åœ°æ–¹");

	        		if (currentContextMenu != null) {
	        			currentContextMenu.hide();
	        		}
				}
	        });
	        
	        
	        accordion.getPanes().add(pane);
	        
    	}
    }

    
    private ContextMenu createContextMenuForUnidad(Unidad unidad,TitledPane pane) {
    	ContextMenu contextMenu = new ContextMenu();
    	
    	// --- 1. ç¼–è¾‘èœå•é¡¹ ---
    	MenuItem editItem = new MenuItem("Editar");
    	editItem.setOnAction(e -> {
    		// ğŸš¨ TODO: æ›¿æ¢ä¸ºå®é™…çš„ç¼–è¾‘é€»è¾‘ï¼Œä¾‹å¦‚æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
    		// System.out.println("Clic en Editar para Unidad: " + unidad.getNombre());
    		 Dialog<Map<String, String>> dialog = new Dialog<>();
			 dialog.setTitle("Editar");
			 dialog.setHeaderText("Introduce el nombre y la descripciÃ³n:");
			 
			 ButtonType saveButtonType = new ButtonType("Guardar", ButtonData.OK_DONE);
			 dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);
			 
			 GridPane grid = new GridPane();
			 grid.setHgap(10);
			 grid.setVgap(10);
			 grid.setPadding(new Insets(20,15,10,10));
			 
			 TextField nameField = new TextField(unidad.getNombre());
			 nameField.setPromptText("Nombre");
			 
			 TextArea descripTextField = new TextArea(unidad.getDescripcion());
			 descripTextField.setWrapText(true);// è‡ªåŠ¨æ¢è¡Œ
			 descripTextField.setPrefSize(400, 300);
			 descripTextField.setPromptText("DescripciÃ³n");
			 
			 grid.add(new Label("Nombre:"), 0, 0);
			 grid.add(nameField, 1, 0);
			 grid.add(new Label("DescripciÃ³n:"), 0, 1);
			 grid.add(descripTextField, 1, 1);
			    
			 dialog.getDialogPane().setContent(grid);
			 
		      dialog.setResultConverter(dialogButton -> {
	               if (dialogButton == saveButtonType) {
	            	   Map<String, String> result = new HashMap<>();
	                   result.put("nombre", nameField.getText());
	                   result.put("descripcion", descripTextField.getText());
	                   return result;
	               }else {
					System.out.println("Not into dialogButton == saveButtonType");
				}
	               return null;
	           });
		      
		      Optional<Map<String, String>> result = dialog.showAndWait();
		      if (result.isPresent()) {
	        	    // El usuario pulsÃ³ "Guardar". Obtenemos el Map con los datos.
	        	    Map<String, String> data = result.get();
	        	    
	        	    String nombre = data.get("nombre");
	        	    String descripcion = data.get("descripcion");
	        	    
	        	    System.out.println("Datos Guardados:");
	        	    System.out.println("Nombre: " + nombre);
	        	    System.out.println("DescripciÃ³n: " + descripcion);
	        	    
	        	    // AquÃ­ puedes llamar a tu mÃ©todo para guardar en la base de datos o aÃ±adir al ListView
	        	   //  boolean success = AsignaturaCRUD.editAsignatura(selected.getId(), nombre, descripcion);
	        	    boolean success = UnidadCRUD.updateUnidad(unidad.getId(), nombre, descripcion);
	        	    if(success) {
	        	    	unidad.setNombre(nombre); 
	        	    	unidad.setDescripcion(descripcion);
	        	    	System.out.println("ä¿®æ”¹æˆåŠŸ");
	            	    // cursoLista.refresh();
	        	    }else {
	        	    	System.err.println("Error en Base de datos, el metodo de AsignaturaCRUD.editAsignatura()");
	        	    }
	               	    
	        	} else {
	        	    // El usuario pulsÃ³ "Cancelar" o cerrÃ³ el diÃ¡logo
	        	    System.out.println("OperaciÃ³n cancelada.");
	        	}
		      
    	});
    	
    	// --- 2. åˆ é™¤èœå•é¡¹ ---
    	MenuItem deleteItem = new MenuItem("Eliminar");
    	deleteItem.setOnAction(e -> {
    		// ğŸš¨ TODO: æ›¿æ¢ä¸ºå®é™…çš„åˆ é™¤é€»è¾‘ï¼Œä¾‹å¦‚å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†å¹¶è°ƒç”¨ DAO
    		System.out.println("Clic en Eliminar para Unidad: " + unidad.getNombre());
    		
    		// 1. åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
            alert.setTitle("Confirmar eliminaciÃ³n");
            alert.setHeaderText("Eliminar Unidad");
            alert.setContentText("Â¿EstÃ¡s seguro de que quieres eliminar la unidad: " + unidad.getNombre() + "?\nEsta acciÃ³n no se puede deshacer.");

            // 2. æ˜¾ç¤ºå¯¹è¯æ¡†å¹¶ç­‰å¾…ç”¨æˆ·ç‚¹å‡»
            Optional<ButtonType> result = alert.showAndWait();

            // 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº† OK
            if (result.isPresent() && result.get() == ButtonType.OK) {
                // 4. è°ƒç”¨æ•°æ®åº“åˆ é™¤
                boolean success = UnidadCRUD.deleteUnidad(unidad.getId());

                if (success) {
                    // 5. æ•°æ®åº“åˆ é™¤æˆåŠŸï¼Œä»ç•Œé¢(Accordion)ç§»é™¤è¯¥é¢æ¿
                    accordion.getPanes().remove(pane);
                    System.out.println("Unidad eliminada correctamente.");
                    
                    // (å¯é€‰) æ£€æŸ¥å¦‚æœå…¨åˆ å…‰äº†ï¼Œæ˜¯å¦è¦æ˜¾ç¤º "æ²¡æœ‰å†…å®¹" çš„æç¤ºï¼Ÿ
                    // æš‚æ—¶å¯ä»¥ä¸å†™ï¼Œå…ˆä¿è¯åŸºæœ¬åŠŸèƒ½ã€‚
                } else {
                    // æ•°æ®åº“åˆ é™¤å¤±è´¥ï¼ˆå¯èƒ½æ˜¯å› ä¸ºé‡Œé¢è¿˜æœ‰æ¨¡å—ï¼Œè§¦å‘äº†å¤–é”®çº¦æŸï¼‰
                    Alert errorAlert = new Alert(Alert.AlertType.ERROR);
                    errorAlert.setTitle("Error");
                    errorAlert.setHeaderText("No se pudo eliminar");
                    errorAlert.setContentText("Hubo un error al eliminar. Verifica si la unidad tiene mÃ³dulos asociados.");
                    errorAlert.show();
                }
            } else {
                System.out.println("EliminaciÃ³n cancelada.");
            }
    	});
    	
    	
    	//--- 3. å¢åŠ èœå•é¡¹ ---
    	MenuItem addItem = new MenuItem("AÃ±adir");
    	addItem.setOnAction(e->{
    		 Dialog<Pair<String, String>> dialog = new Dialog<>();
	           dialog.setTitle("Nuevos Unidades");
	           dialog.setHeaderText("Por favor, introduzca los detalles de Unidades.");
	           ButtonType loginButtonType = new ButtonType("Guardar", ButtonData.OK_DONE);
	           dialog.getDialogPane().getButtonTypes().addAll(loginButtonType, ButtonType.CANCEL);

	           GridPane grid = new GridPane();
	           grid.setHgap(10);
	           grid.setVgap(10);
	           grid.setPadding(new javafx.geometry.Insets(20, 150, 10, 10));

	           TextField nameField = new TextField();
	           nameField.setPromptText("Nombre");
	           TextArea descField = new TextArea();
	           descField.setPromptText("Descripcion");
	           descField.setPrefRowCount(3);
	           descField.setPrefWidth(200);

	           grid.add(new Label("Nombre:"), 0, 0);
	           grid.add(nameField, 1, 0);
	           grid.add(new Label("Descripcion:"), 0, 1);
	           grid.add(descField, 1, 1);

	           dialog.getDialogPane().setContent(grid);
	           javafx.application.Platform.runLater(nameField::requestFocus);

	           dialog.setResultConverter(dialogButton -> {
	               if (dialogButton == loginButtonType) {
	                   return new Pair<>(nameField.getText(), descField.getText());
	               }
	               return null;
	           });

	           Optional<Pair<String, String>> result = dialog.showAndWait();
	           result.ifPresent(pair -> {
	               String nombreInput = pair.getKey();
	               String descInput = pair.getValue();
	               if (nombreInput == null || nombreInput.trim().isEmpty()) {
	                   new Alert(Alert.AlertType.WARNING, "Â¡El nombre no puede estar vacÃ­o!").show();
	                   return;
	               }
	               
	               // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
	               int currentProfesorId = AppSession.getAlumno().getId(); 
	               
	               // è°ƒç”¨åç«¯æ’å…¥
	               // Asignatura newAsignatura = AsignaturaCRUD.insertarAsignatura(nombreInput, currentProfesorId, descInput);
	               Unidad newUnidad = UnidadCRUD.createUnidad(nombreInput, descInput,this.id_asignatura);
	               if (newUnidad != null) {
	            	   addUnidadToAccordion(newUnidad);

	               } else {
	                   new Alert(Alert.AlertType.ERROR, "Error al guardar").show();
	               }
	           });
    	});
    	
    	// å°†èœå•é¡¹æ·»åŠ åˆ° ContextMenu
    	contextMenu.getItems().addAll(editItem, deleteItem,addItem);
    	
    	return contextMenu;
    }


    
    private void addUnidadToAccordion(Unidad u) {
        VBox box = new VBox(10);
        box.setPadding(new Insets(10));

        Label descripcionLabel = new Label();
        descripcionLabel.textProperty().bind(u.descripcionProperty());
        descripcionLabel.setWrapText(true);

        Label temarioLabel = new Label("Temario");
        temarioLabel.setStyle("-fx-font-weight: bold; -fx-font-size: 14px;");

        ListView<Modulo> moduloListView = new ListView<>();
        if(u.getModulos()!=null) {
        	   ObservableList<Modulo> observableList =
            FXCollections.observableArrayList(u.getModulos()); moduloListView.setItems(observableList);
            box.getChildren().addAll(descripcionLabel, temarioLabel, moduloListView);
            
        }else {
        	  box.getChildren().addAll(descripcionLabel, temarioLabel);
        }
     
        TitledPane pane = new TitledPane();
        pane.textProperty().bind(u.nombreProperty());
        pane.setContent(box);

        accordion.getPanes().add(pane);
    }

    
    public void setId_asignatura(int id) {
    	this.id_asignatura = id;
    	cargarUnidadesYAsignatura(id);
    }
    
    public int getId_asignatura() {
    	return id_asignatura;
    }
    
    private void setupModuloListView(ListView<Modulo> listView, Unidad unidad, ObservableList<Modulo> listData) {
    	// 1. è®¾ç½®å…¨å±€ï¼ˆç©ºç™½å¤„ï¼‰å³é”®èœå• -> å¢åŠ 
        listView.setContextMenu(createGlobalMenu(unidad, listData));
        
        // 2. è®¾ç½® CellFactory (ä½¿ç”¨æ˜¾å¼çš„ Callback å†™æ³•)
        listView.setCellFactory(new Callback<ListView<Modulo>, ListCell<Modulo>>() {
			
			@Override
			public ListCell<Modulo> call(ListView<Modulo> param) {
				// è¿™é‡Œéœ€è¦æ‰‹å†™ï¼Œæ¥è¿”å›ä¸€ä¸ªListCellå¯¹è±¡
				return new ListCell<Modulo>() {
					@Override
	                protected void updateItem(Modulo item, boolean empty) {
	                    super.updateItem(item, empty);
	                    
	                    if (empty || item == null) {
	                        setText(null);
	                        // ç©ºè¡Œï¼šæ²¡æœ‰ä¸“å±èœå•
	                        setContextMenu(null); 
	                    } else {
	                        setText(item.getTitulo());
	                        // æœ‰æ•°æ®ï¼šåˆ›å»ºä¸“å±èœå•
	                        setContextMenu(createItemMenu(item, listData));
	                    }
	                }
					// è¿™æ˜¯ä¸€ä¸ªå®ä¾‹åˆå§‹åŒ–å—ï¼ˆç›¸å½“äºæ„é€ å‡½æ•°çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚
					// æ³¨æ„ï¼šListCell æ˜¯ä¸€ä¸ª Nodeï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œå†™é€»è¾‘
					{
	                    this.setOnMouseClicked(event -> {
	                        // "this" æŒ‡çš„æ˜¯å½“å‰çš„ ListCell å®ä¾‹
	                        if (!this.isEmpty() && event.getButton() == javafx.scene.input.MouseButton.PRIMARY 
	                                && event.getClickCount() == 2) {
	                            
	                            handleDoubleClick(this.getItem());
	                        }
	                    });
	                }
					
				};
			}
		});
    }
    
 // æ„å»ºã€ç©ºç™½å¤„ã€‘çš„èœå•ï¼šåªæœ‰â€œå¢åŠ â€
    private ContextMenu createGlobalMenu(Unidad unidad, ObservableList<Modulo> listData) {
        ContextMenu menu = new ContextMenu();
        MenuItem addItem = new MenuItem("AÃ±adir MÃ³dulo");
        
        // ç»‘å®šäº‹ä»¶ï¼šå¢åŠ 
        addItem.setOnAction(e -> handleAddModulo(unidad, listData));
        
        menu.getItems().add(addItem);
        return menu;
    }

    // æ„å»ºã€Itemã€‘çš„èœå•ï¼šç¼–è¾‘ + åˆ é™¤
    private ContextMenu createItemMenu(Modulo modulo, ObservableList<Modulo> listData) {
        ContextMenu menu = new ContextMenu();
        
        MenuItem editItem = new MenuItem("Editar");
        editItem.setOnAction(e -> handleEditModulo(modulo, listData)); // ç»‘å®šäº‹ä»¶ï¼šç¼–è¾‘

        MenuItem deleteItem = new MenuItem("Eliminar");
        deleteItem.setOnAction(e -> handleDeleteModulo(modulo, listData)); // ç»‘å®šäº‹ä»¶ï¼šåˆ é™¤

        menu.getItems().addAll(editItem, deleteItem);
        return menu;
    }
    
 // --- å¤„ç†åŒå‡» (äº‹ä»¶1) ---
    private void handleDoubleClick(Modulo modulo) {
        System.out.println("åŒå‡»è§¦å‘ï¼šæ‰“å¼€æ–‡ä»¶ -> " + modulo.getRuta_archivo());
        // TODO: è¿™é‡Œå†™æ‰“å¼€æ–‡ä»¶çš„ä»£ç ï¼Œä¾‹å¦‚ getHostServices().showDocument(...)
    }

    // --- å¤„ç†å¢åŠ  ç‰ˆæœ¬1 ---
    private void handleAddModulo(Unidad unidad, ObservableList<Modulo> listData) {
        System.out.println("å‡†å¤‡åœ¨å•å…ƒ [" + unidad.getNombre() + "] ä¸‹å¢åŠ æ¨¡å—");
        
        // 1. å¼¹å‡ºè¾“å…¥æ¡† (å¤ç”¨ä¹‹å‰çš„ Dialog é€»è¾‘ï¼Œæˆ–è€…ç®€åŒ–ç‰ˆ)
        TextInputDialog dialog = new TextInputDialog();
        dialog.setTitle("Nuevo MÃ³dulo");
        dialog.setHeaderText("AÃ±adir mÃ³dulo a: " + unidad.getNombre());
        dialog.setContentText("Nombre del mÃ³dulo:");

        Optional<String> result = dialog.showAndWait();
        result.ifPresent(nombre -> {
            // 2. è°ƒç”¨æ•°æ®åº“æ’å…¥
            // æ³¨æ„ï¼šä½ éœ€è¦ç¡®ä¿ ModuloCRUD æœ‰ createModulo æ–¹æ³•
            // Modulo newModulo = ModuloCRUD.createModulo(nombre, "ruta/dummy", unidad.getId());
            
        	Modulo newModulo = ModuloCRUD.addModulo(nombre, "/ruta", unidad.getId());
       

            if (newModulo != null) {
                listData.add(newModulo); // æ›´æ–° UI
                System.out.println("å¢åŠ æˆåŠŸ");
            }
        });
    }
    

 
    
    // --- å¤„ç†ç¼–è¾‘ ---
    private void handleEditModulo(Modulo modulo, ObservableList<Modulo> listData) {
        // 1. å¼¹å‡ºè¾“å…¥æ¡†
        TextInputDialog dialog = new TextInputDialog(modulo.getTitulo());
        dialog.setTitle("Editar MÃ³dulo");
        dialog.setHeaderText("Editar nombre del mÃ³dulo");
        dialog.setContentText("Nombre:");

        Optional<String> result = dialog.showAndWait();
        result.ifPresent(nuevoNombre -> {
            // 2. è°ƒç”¨æ•°æ®åº“æ›´æ–°
           boolean success = ModuloCRUD.editModulo(modulo.getId(),nuevoNombre,"",modulo.getId_categoria());

            if (success) {
                modulo.setTitulo(nuevoNombre); // æ›´æ–°å†…å­˜å¯¹è±¡
                
                // 3. å¼ºåˆ¶åˆ·æ–° ListView (å› ä¸º Modulo ä¸æ˜¯ Property å¯¹è±¡ï¼ŒListView å¯èƒ½ä¸çŸ¥é“å®ƒå˜äº†)
                // è¿™ç§ç®€ä¾¿æ–¹æ³•å¯ä»¥è§¦å‘åˆ·æ–°ï¼š
                int index = listData.indexOf(modulo);
                listData.set(index, modulo); 
                
                System.out.println("æ›´æ–°æˆåŠŸ");
            }
        });
    }

    // --- å¤„ç†åˆ é™¤ ---
    private void handleDeleteModulo(Modulo modulo, ObservableList<Modulo> listData) {
        // 1. ç¡®è®¤å¯¹è¯æ¡†
        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
        alert.setTitle("Eliminar");
        alert.setHeaderText("Â¿Eliminar este mÃ³dulo?");
        alert.setContentText(modulo.getTitulo());

        Optional<ButtonType> result = alert.showAndWait();
        if (result.isPresent() && result.get() == ButtonType.OK) {
            // 2. è°ƒç”¨æ•°æ®åº“åˆ é™¤
             boolean success = ModuloCRUD.deleteModulo(modulo.getId());
           

            if (success) {
                listData.remove(modulo); // æ›´æ–° UIï¼Œç§»é™¤è¯¥é¡¹
                System.out.println("åˆ é™¤æˆåŠŸ");
            }
        }
    }
}
